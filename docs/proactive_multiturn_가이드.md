# Proactive Multiturn Review ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨

1. [ë³€ê²½ ë°°ê²½](#ë³€ê²½-ë°°ê²½)
2. [ì‘ë™ ë°©ì‹](#ì‘ë™-ë°©ì‹)
3. [ì„¤ì • ë°©ë²•](#ì„¤ì •-ë°©ë²•)
4. [Fallback ë©”ì»¤ë‹ˆì¦˜](#fallback-ë©”ì»¤ë‹ˆì¦˜)
5. [ë¦¬ìŠ¤í¬ ë° ì œí•œì‚¬í•­](#ë¦¬ìŠ¤í¬-ë°-ì œí•œì‚¬í•­)
6. [ì½”ë“œ ë³€ê²½ì ](#ì½”ë“œ-ë³€ê²½ì )
7. [ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨](#ì•„í‚¤í…ì²˜-ë‹¤ì´ì–´ê·¸ë¨)

---

## ë³€ê²½ ë°°ê²½

### ê¸°ì¡´ ë°©ì‹: ì—ëŸ¬ ê¸°ë°˜ Multiturn (Reactive)

**ë¬¸ì œì **:
- LLM API í˜¸ì¶œ í›„ ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼ multiturn ëª¨ë“œë¡œ ì „í™˜
- ë¶ˆí•„ìš”í•œ API í˜¸ì¶œ ë¹„ìš© ë°œìƒ
- ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë™ì‘
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜ (ì—ëŸ¬ â†’ ì¬ì‹œë„ ê³¼ì • ë…¸ì¶œ)

**ì‘ë™ íë¦„**:
```
ë¦¬ë·° ìš”ì²­ â†’ LLM API í˜¸ì¶œ â†’ Context Limit ì—ëŸ¬ â†’ Multiturn ëª¨ë“œ ì „í™˜
```

### ë³€ê²½ ë°©ì‹: ì‚¬ì „ ì²´í¬ ê¸°ë°˜ Multiturn (Proactive)

**ê°œì„ ì **:
- ë¦¬ë·° ìš”ì²­ ì „ì— í† í° ìˆ˜ë¥¼ ë¯¸ë¦¬ ê³„ì‚°
- ì„ê³„ê°’(ê¸°ë³¸ 10ë§Œ í† í°) ì´ˆê³¼ ì‹œ ì‚¬ì „ì— multiturn ëª¨ë“œë¡œ ì§„ì…
- ë¶ˆí•„ìš”í•œ API ì—ëŸ¬ ë°©ì§€
- ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‘
- ë” ë‚˜ì€ ì‚¬ìš©ì ê²½í—˜

**ì‘ë™ íë¦„**:
```
ë¦¬ë·° ìš”ì²­ â†’ í† í° ìˆ˜ ê³„ì‚° â†’ 10ë§Œ ì´ˆê³¼? â†’ Yes: Multiturn ëª¨ë“œ | No: ì¼ë°˜ ë¦¬ë·°
```

---

## ì‘ë™ ë°©ì‹

### 1. í† í° ê³„ì‚°

ë¦¬ë·° ìš”ì²­ ì‹œ `ProactiveTokenChecker`ê°€ ìë™ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ì˜ ì´ í† í° ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.

**ê³„ì‚° ëŒ€ìƒ**:
- System Prompt í† í°
- User Prompts í† í° (íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ + ë³€ê²½ ë‚´ìš©)

**ê³„ì‚° ë°©ë²•**:
- **Primary**: tiktoken (OpenAIì˜ cl100k_base ì¸ì½”ë”© ì‚¬ìš©)
- **Fallback**: ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ì¶”ì • (1í† í° â‰ˆ 3.5ì)

### 2. ì„ê³„ê°’ ë¹„êµ

ê³„ì‚°ëœ í† í° ìˆ˜ë¥¼ ì„¤ì •ëœ ì„ê³„ê°’ê³¼ ë¹„êµí•©ë‹ˆë‹¤.

**ê¸°ë³¸ ì„ê³„ê°’**: 100,000 í† í°

```python
if total_tokens > threshold:
    # Proactive multiturn ëª¨ë“œ
else:
    # ì¼ë°˜ ë¦¬ë·° ëª¨ë“œ
```

### 3. Multiturn ì‹¤í–‰

ì„ê³„ê°’ì„ ì´ˆê³¼í•˜ë©´ ìë™ìœ¼ë¡œ multiturn ëª¨ë“œë¡œ ì§„ì…í•©ë‹ˆë‹¤.

**Multiturn ì²˜ë¦¬ ê³¼ì •**:
1. í”„ë¡¬í”„íŠ¸ë¥¼ ì—¬ëŸ¬ ì²­í¬ë¡œ ë¶„í• 
2. ê° ì²­í¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ LLMì— ìš”ì²­
3. ê²°ê³¼ë¥¼ í•©ì„±í•˜ì—¬ ìµœì¢… ë¦¬ë·° ìƒì„±

---

## ì„¤ì • ë°©ë²•

### 1. ê¸°ë³¸ê°’ í™•ì¸

```bash
selvage config proactive-multiturn-threshold
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
Proactive multiturn threshold: 100,000 tokens

To change: selvage config proactive-multiturn-threshold <tokens>
```

### 2. ì„ê³„ê°’ ë³€ê²½

```bash
selvage config proactive-multiturn-threshold 150000
```

**ì„±ê³µ ë©”ì‹œì§€**:
```
Proactive multiturn threshold has been set to 150,000 tokens.
```

### 3. ì „ì²´ ì„¤ì • í™•ì¸

```bash
selvage config list
```

**ì¶œë ¥ì— í¬í•¨**:
```
Default Settings
Default model: claude-sonnet-4
Default language: Korean
Debug mode: False
Review log directory: /Users/username/.config/selvage/review_log
Proactive multiturn threshold: 100,000 tokens
```

### 4. ì„¤ì • íŒŒì¼ ìœ„ì¹˜

**macOS/Linux**:
```
~/.config/selvage/config.ini
```

**Windows**:
```
%LOCALAPPDATA%\selvage\config.ini
```

**ì„¤ì • íŒŒì¼ ë‚´ìš©**:
```ini
[multiturn]
proactive_threshold = 100000
```

---

## Fallback ë©”ì»¤ë‹ˆì¦˜

Proactive multiturnì´ ì‹¤íŒ¨í•˜ê±°ë‚˜ ë¶€ì •í™•í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ Fallback ì‹œìŠ¤í…œì´ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### Fallback ì‹œë‚˜ë¦¬ì˜¤

#### 1. tiktoken ê³„ì‚° ì‹¤íŒ¨
```
tiktoken ì—ëŸ¬ â†’ ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ì¶”ì • â†’ ê³„ì† ì§„í–‰
```

#### 2. ì‚¬ì „ ì²´í¬ í†µê³¼í–ˆì§€ë§Œ ì‹¤ì œ API ì—ëŸ¬ ë°œìƒ
```
ì‚¬ì „ ì²´í¬ (í† í° < 10ë§Œ) â†’ ì¼ë°˜ ë¦¬ë·° ì‹œë„ â†’ Context Limit ì—ëŸ¬ â†’ ì—ëŸ¬ ê¸°ë°˜ Multiturn ì‹¤í–‰
```

### Fallback Multiturn

ê¸°ì¡´ ì—ëŸ¬ ê¸°ë°˜ multiturn ë¡œì§ì€ fallbackìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.

**ì‘ë™ ë°©ì‹**:
- API ì—ëŸ¬ ì‘ë‹µì—ì„œ í† í° ì •ë³´ ì¶”ì¶œ
- í”„ë¡œë°”ì´ë”ë³„ ì—ëŸ¬ íŒ¨í„´ ë§¤ì¹­
- ë™ì  ë¶„í•  ë¹„ìœ¨ ê³„ì‚°

**ì¥ì **:
- ì´ì¤‘ ì•ˆì „ ì¥ì¹˜
- tiktoken ë¶€ì •í™•ì„± ë³´ì™„
- ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ì˜ í˜¸í™˜ì„± ìœ ì§€

---

## ë¦¬ìŠ¤í¬ ë° ì œí•œì‚¬í•­

### 1. í† í° ê³„ì‚° ì˜¤ì°¨

**ë¬¸ì œ**:
- tiktoken(cl100k_base)ê³¼ ì‹¤ì œ LLM í† í¬ë‚˜ì´ì €ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
- Anthropic (Claude): ìì²´ í† í¬ë‚˜ì´ì € ì‚¬ìš©
- Google (Gemini): ìì²´ í† í¬ë‚˜ì´ì € ì‚¬ìš©
- OpenRouter: ëª¨ë¸ë³„ë¡œ ë‹¤ë¥¸ í† í¬ë‚˜ì´ì €

**ì˜í–¥**:
- 10ë§Œ í† í° ì´í•˜ë¡œ ê³„ì‚°í–ˆì§€ë§Œ ì‹¤ì œë¡œëŠ” ì´ˆê³¼ ê°€ëŠ¥ â†’ Fallbackìœ¼ë¡œ ì²˜ë¦¬
- 10ë§Œ í† í° ì´ˆê³¼ë¡œ ê³„ì‚°í–ˆì§€ë§Œ ì‹¤ì œë¡œëŠ” ì´í•˜ ê°€ëŠ¥ â†’ ë¶ˆí•„ìš”í•œ multiturn ì‹¤í–‰

**ëŒ€ì‘**:
- Fallback ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì•ˆì •ì„± ë³´ì¥
- ì‚¬ìš©ìê°€ threshold ì¡°ì • ê°€ëŠ¥

### 2. ë¶ˆí•„ìš”í•œ Multiturn ì‹¤í–‰

**ë¬¸ì œ**:
- tiktokenì´ ê³¼ëŒ€í‰ê°€í•˜ë©´ ë¶ˆí•„ìš”í•˜ê²Œ multiturn ì‹¤í–‰
- Multiturnì€ ìˆœì°¨ ì²˜ë¦¬ + Summary í•©ì„±ìœ¼ë¡œ ì‹œê°„ ì¦ê°€
- Summary í•©ì„±ì— ì¶”ê°€ LLM í˜¸ì¶œ ë¹„ìš© ë°œìƒ

**ì˜í–¥**:
- ì„±ëŠ¥ ì €í•˜ (ìˆœì°¨ ì²˜ë¦¬)
- ë¹„ìš© ì¦ê°€ (í•©ì„± ë¹„ìš©)

**ëŒ€ì‘**:
- Thresholdë¥¼ ì¡°ì •í•˜ì—¬ ìµœì í™”
- ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ì ì ˆí•œ ê°’ ì°¾ê¸°

### 3. Fallback ê²½ë¡œ ë³µì¡ë„

**ë¬¸ì œ**:
- ì‚¬ì „ ì²´í¬ + ì—ëŸ¬ í•¸ë“¤ë§ ë‘ ê²½ë¡œ ìœ ì§€
- ì½”ë“œ ë³µì¡ë„ ì¦ê°€
- í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¦ê°€

**ì˜í–¥**:
- ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´
- ì ì¬ì  ë²„ê·¸ ì¦ê°€ ê°€ëŠ¥ì„±

**ëŒ€ì‘**:
- ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ìœ ì§€
- ì‹ ê·œ í…ŒìŠ¤íŠ¸ ì¶”ê°€
- ì½”ë“œ ë¦¬ë·° ê°•í™”

### 4. í”„ë¡œë°”ì´ë”ë³„ ì°¨ì´

**í”„ë¡œë°”ì´ë”ë³„ í† í° ê³„ì‚° ì •í™•ë„**:

| í”„ë¡œë°”ì´ë” | í† í¬ë‚˜ì´ì € | tiktoken ì •í™•ë„ | ë¹„ê³  |
|-----------|-----------|----------------|------|
| OpenAI | cl100k_base | â­â­â­â­â­ | 100% ì¼ì¹˜ |
| Anthropic | Claude ì „ìš© | â­â­â­ | ìœ ì‚¬í•˜ë‚˜ ì°¨ì´ ìˆìŒ |
| Google Gemini | Gemini ì „ìš© | â­â­ | ì°¨ì´ í¼ |
| OpenRouter | ëª¨ë¸ë³„ ìƒì´ | â­â­ | ëª¨ë¸ì— ë”°ë¼ ë‹¤ë¦„ |

---

## ì½”ë“œ ë³€ê²½ì 

### 1. ìƒˆë¡œìš´ íŒŒì¼

#### `selvage/src/utils/proactive_token_checker.py`
```python
class ProactiveTokenChecker:
    """í”„ë¡¬í”„íŠ¸ì˜ í† í° ìˆ˜ë¥¼ ì‚¬ì „ ê³„ì‚°í•˜ëŠ” í´ë˜ìŠ¤"""

    def calculate_total_tokens(self, review_prompt) -> int:
        """System prompt + User promptsì˜ ì´ í† í° ìˆ˜ ê³„ì‚°"""
        # tiktoken ê¸°ë°˜ ì •í™•í•œ í† í° ê³„ì‚°
        # Fallback: ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ì¶”ì •
```

**ì—­í• **:
- ReviewPromptWithFileContent ê°ì²´ë¥¼ ë°›ì•„ í† í° ìˆ˜ ê³„ì‚°
- tiktoken ì‚¬ìš© (cl100k_base)
- Fallback ì§€ì›

### 2. ìˆ˜ì •ëœ íŒŒì¼

#### `selvage/src/config.py`

**ì¶”ê°€ëœ í•¨ìˆ˜**:
```python
def get_proactive_multiturn_threshold() -> int:
    """ê¸°ë³¸ê°’: 100,000"""

def set_proactive_multiturn_threshold(threshold: int) -> bool:
    """ì–‘ìˆ˜ ê²€ì¦ í¬í•¨"""
```

**ì¶”ê°€ëœ ì„¹ì…˜**:
```python
DEFAULT_SECTIONS = [
    "paths",
    "default",
    "debug",
    "language",
    "multiturn",  # ì‹ ê·œ ì¶”ê°€
]
```

#### `selvage/cli.py`

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:

1. **Import ì¶”ê°€**:
```python
from selvage.src.config import (
    get_proactive_multiturn_threshold,
    set_proactive_multiturn_threshold,
)
from selvage.src.utils.proactive_token_checker import ProactiveTokenChecker
```

2. **_perform_new_review í•¨ìˆ˜ ìˆ˜ì •** (L283-334):
```python
def _perform_new_review(review_request):
    # 1. í”„ë¡¬í”„íŠ¸ ìƒì„±
    review_prompt = PromptGenerator().create_code_review_prompt(review_request)

    # 2. Proactive multiturn ì²´í¬
    threshold = get_proactive_multiturn_threshold()
    token_checker = ProactiveTokenChecker()
    total_tokens = token_checker.calculate_total_tokens(review_prompt)

    # 3. ì„ê³„ê°’ ì´ˆê³¼ ì‹œ proactive multiturn
    if total_tokens > threshold:
        return _handle_proactive_multiturn(...)

    # 4. ì„ê³„ê°’ ì´í•˜: ì¼ë°˜ ë¦¬ë·°
    review_result = llm_gateway.review_code(review_prompt)

    # 5. Fallback: ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ê¸°ë°˜ multiturn
    if error_response.is_context_limit_error():
        return _handle_context_limit_error(...)
```

3. **_handle_proactive_multiturn í•¨ìˆ˜ ì¶”ê°€** (L212-228):
```python
def _handle_proactive_multiturn(...):
    """ì‚¬ì „ í† í° ì²´í¬ë¡œ ì¸í•œ proactive multiturn review ì‹¤í–‰"""
    token_info = TokenInfo(actual_tokens=total_tokens, max_tokens=threshold)
    executor = MultiturnReviewExecutor()
    return executor.execute_multiturn_review(...)
```

4. **Config ëª…ë ¹ì–´ ì¶”ê°€** (L678-682):
```python
@config.command(name="proactive-multiturn-threshold")
@click.argument("threshold", type=int, required=False)
def proactive_multiturn_threshold(threshold: int | None) -> None:
    """Proactive multiturn threshold setting (in tokens)"""
    config_proactive_multiturn_threshold(threshold)
```

5. **Config í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì¶”ê°€** (L153-170):
```python
def config_proactive_multiturn_threshold(threshold: int | None = None) -> None:
    if threshold is None:
        # í˜„ì¬ ì„¤ì •ê°’ í‘œì‹œ
    else:
        # ì„¤ì •ê°’ ì—…ë°ì´íŠ¸
        set_proactive_multiturn_threshold(threshold)
```

6. **Config list ì¶œë ¥ ìˆ˜ì •** (L231-235):
```python
def config_list() -> None:
    # ... ê¸°ì¡´ ì¶œë ¥ ...

    # Proactive multiturn threshold í‘œì‹œ
    proactive_threshold = get_proactive_multiturn_threshold()
    console.print(f"Proactive multiturn threshold: {proactive_threshold:,} tokens")
```

### 3. TokenInfo ëª¨ë¸ (ë³€ê²½ ì—†ìŒ)

`selvage/src/multiturn/models.py`ì˜ `TokenInfo` í´ë˜ìŠ¤ëŠ” ì´ë¯¸ dataclassë¡œ ì •ì˜ë˜ì–´ ìˆì–´ ì§ì ‘ ìƒì„±ì ì‚¬ìš© ê°€ëŠ¥:

```python
token_info = TokenInfo(
    actual_tokens=total_tokens,
    max_tokens=threshold
)
```

### 4. í…ŒìŠ¤íŠ¸ íŒŒì¼

#### `tests/test_proactive_token_checker.py` (ì‹ ê·œ)
- ProactiveTokenCheckerì˜ í† í° ê³„ì‚° ë¡œì§ í…ŒìŠ¤íŠ¸
- tiktoken ì„±ê³µ/ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤
- Fallback ì¶”ì • í…ŒìŠ¤íŠ¸
- ëŒ€ìš©ëŸ‰ ì»¨í…ìŠ¤íŠ¸ í…ŒìŠ¤íŠ¸

#### `tests/test_config_proactive_multiturn.py` (ì‹ ê·œ)
- get/set proactive_multiturn_threshold í…ŒìŠ¤íŠ¸
- ê¸°ë³¸ê°’, ìœ íš¨ì„± ê²€ì¦, ì˜ì†ì„± í…ŒìŠ¤íŠ¸
- ìŒìˆ˜/0 ì…ë ¥ ê±°ë¶€ í…ŒìŠ¤íŠ¸
- ì†ìƒëœ ì„¤ì • íŒŒì¼ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸

---

## ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

### ë³€ê²½ ì „: ì—ëŸ¬ ê¸°ë°˜ Multiturn

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CLI: review command              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PromptGenerator.create_prompt        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LLM API í˜¸ì¶œ (ì¼ë°˜ ë¦¬ë·°)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ì„±ê³µ?           â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
      Yes             No
       â”‚               â”‚
       â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì™„ë£Œ      â”‚  â”‚ Context Limit ì—ëŸ¬?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                 â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                Yes          No
                 â”‚            â”‚
                 â–¼            â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Multiturn    â”‚  â”‚ ë‹¤ë¥¸ ì—ëŸ¬ â”‚
         â”‚  ëª¨ë“œ ì „í™˜     â”‚  â”‚   ì²˜ë¦¬   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë³€ê²½ í›„: Proactive Multiturn + Fallback

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CLI: review command              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PromptGenerator.create_prompt        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProactiveTokenChecker.calculate_tokens     â”‚
â”‚  - tiktoken ì‚¬ìš© (cl100k_base)               â”‚
â”‚  - Fallback: ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ì¶”ì •            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ í† í° > 10ë§Œ?     â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
      Yes             No
       â”‚               â”‚
       â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proactive     â”‚  â”‚   LLM API í˜¸ì¶œ      â”‚
â”‚ Multiturn     â”‚  â”‚   (ì¼ë°˜ ë¦¬ë·°)        â”‚
â”‚ ì‹¤í–‰          â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ì„±ê³µ?           â”‚
                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                â”‚               â”‚
               Yes             No
                â”‚               â”‚
                â–¼               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ì™„ë£Œ      â”‚  â”‚ Context Limit ì—ëŸ¬?  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                          â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                         Yes          No
                          â”‚            â”‚
                          â–¼            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Fallback     â”‚  â”‚ ë‹¤ë¥¸ ì—ëŸ¬ â”‚
                  â”‚  Multiturn    â”‚  â”‚   ì²˜ë¦¬   â”‚
                  â”‚  ì‹¤í–‰         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Proactive Token Checker ë‚´ë¶€ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ProactiveTokenChecker                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ calculate_total_tokens()             â”‚   â”‚
â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚  1. System Prompt í† í° ê³„ì‚°          â”‚   â”‚
â”‚  â”‚     - tiktoken.encode(content)       â”‚   â”‚
â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚  2. User Prompts í† í° ê³„ì‚° (ê°ê°)    â”‚   â”‚
â”‚  â”‚     - file_context í† í°              â”‚   â”‚
â”‚  â”‚     - formatted_hunks í† í°           â”‚   â”‚
â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚  3. í•©ì‚°: system + sum(user)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                â”‚
â”‚             â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ tiktoken ì„±ê³µ?                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                              â”‚
â”‚   Yes        No                              â”‚
â”‚    â”‚          â”‚                              â”‚
â”‚    â–¼          â–¼                              â”‚
â”‚  ì •í™•í•œ    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  í† í° ìˆ˜   â”‚ _fallback_estimate_tokens()  â”‚  â”‚
â”‚           â”‚  - ë¬¸ìì—´ ê¸¸ì´ / 3.5          â”‚  â”‚
â”‚           â”‚  - ì½”ë“œ í† í° ë°€ë„ ê³ ë ¤         â”‚  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ëª¨ë‹ˆí„°ë§ ë° ìµœì í™”

### 1. ë¡œê·¸ í™•ì¸

Debug ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì—¬ í† í° ê³„ì‚° ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
selvage config debug-mode on
selvage review
```

**ë¡œê·¸ ì˜ˆì‹œ**:
```
Total tokens calculated: 85,432 (system: 3,245, user: 82,187)
Context size: 85,432 tokens is below threshold (100,000). Using normal review mode.
```

ë˜ëŠ”

```
Total tokens calculated: 125,678 (system: 3,245, user: 122,433)
Context size: 125,678 tokens exceeds threshold (100,000). Using multiturn mode...
```

### 2. Threshold ìµœì í™”

í”„ë¡œì íŠ¸ì— ë”°ë¼ ì ì ˆí•œ thresholdë¥¼ ì°¾ì•„ ì„¤ì •í•˜ì„¸ìš”:

**ì‘ì€ í”„ë¡œì íŠ¸** (íŒŒì¼ ìˆ˜ ì ìŒ, ë³€ê²½ ì‘ìŒ):
```bash
selvage config proactive-multiturn-threshold 80000
```

**í° í”„ë¡œì íŠ¸** (íŒŒì¼ ìˆ˜ ë§ìŒ, ë³€ê²½ í¼):
```bash
selvage config proactive-multiturn-threshold 150000
```

### 3. ì„±ëŠ¥ ì¸¡ì •

Multiturn ì‹¤í–‰ ì‹œ ë¹„ìš© ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤:

```
Review completed successfully!

Cost Information:
- Chunk 1: $0.25 (50,000 input tokens, 2,000 output tokens)
- Chunk 2: $0.22 (45,000 input tokens, 1,800 output tokens)
- Chunk 3: $0.18 (35,000 input tokens, 1,500 output tokens)
- Summary Synthesis: $0.05 (3,000 input tokens, 500 output tokens)
Total Cost: $0.70
```

---

## FAQ

### Q1: tiktokenì´ ì‹¤íŒ¨í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?

**A**: Fallbackìœ¼ë¡œ ë¬¸ìì—´ ê¸¸ì´ ê¸°ë°˜ ì¶”ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì •í™•ë„ëŠ” ë–¨ì–´ì§€ì§€ë§Œ ê³„ì† ì‘ë™í•˜ë©°, ì‹¤ì œ API ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ê¸°ë°˜ multiturnìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

### Q2: ì„ê³„ê°’ì„ ë„ˆë¬´ ë‚®ê²Œ ì„¤ì •í•˜ë©´?

**A**: ë¶ˆí•„ìš”í•˜ê²Œ multiturnì´ ìì£¼ ì‹¤í–‰ë˜ì–´ ì„±ëŠ¥ê³¼ ë¹„ìš©ì´ ì¦ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ì— ë§ëŠ” ì ì ˆí•œ ê°’ì„ ì°¾ìœ¼ì„¸ìš”.

### Q3: ì„ê³„ê°’ì„ ë„ˆë¬´ ë†’ê²Œ ì„¤ì •í•˜ë©´?

**A**: Proactive multiturnì´ ê±°ì˜ ì‹¤í–‰ë˜ì§€ ì•Šì•„ API ì—ëŸ¬ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤. í•˜ì§€ë§Œ Fallback ë©”ì»¤ë‹ˆì¦˜ì´ ìˆì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

### Q4: OpenAIê°€ ì•„ë‹Œ ë‹¤ë¥¸ LLM ì‚¬ìš© ì‹œ ì •í™•í•œê°€ìš”?

**A**: tiktokenì€ OpenAI ê¸°ì¤€ì´ë¯€ë¡œ Claude, Gemini ë“±ì—ì„œëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ Fallback ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì•ˆì •ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

### Q5: ê¸°ì¡´ ì—ëŸ¬ ê¸°ë°˜ multiturnì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?

**A**: Fallbackìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤. Proactive ì²´í¬ê°€ ë¶€ì •í™•í•˜ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì´ì¤‘ ì•ˆì „ ì¥ì¹˜ì…ë‹ˆë‹¤.

---

## ì°¸ê³  ìë£Œ

- [Multiturn Review System ë¬¸ì„œ](../.cursor/rules/multiturn-review-system.mdc)
- [CLAUDE.md](../CLAUDE.md)
- [tiktoken GitHub](https://github.com/openai/tiktoken)
- [OpenAI Tokenizer](https://platform.openai.com/tokenizer)

---

**ì‘ì„±ì¼**: 2025-11-16
**ë²„ì „**: 1.0.0
**ì‘ì„±ì**: Claude (with Human Guidance)
